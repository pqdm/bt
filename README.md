# 宝塔面板服务器维护工具

## 简介
这是一个专为宝塔面板设计的服务器维护工具，可以帮助您保护您的Web服务器免受CC攻击并进行系统维护。

作者: 咸鱼神秘人  
微信: dingyanan2008  
QQ: 314450957

## 功能特点
- **实时监控系统状态** - 监控CPU、内存、网络连接等系统资源
- **CPU监控增强** - 多次采样(3s平均)、每核展开、显示us/sy/wa/st并带阈值告警
- **分析Web访问日志** - 智能分析访问日志，识别异常流量模式
- **检测和防御CC攻击** - 自动检测并防御CC攻击，支持多种防护策略
- **监控异常进程** - 实时监控系统进程，识别可疑和恶意进程
- **管理黑名单和白名单** - 灵活的IP黑白名单管理，支持自动和手动管理
- **系统异常一键拉黑** - “检测系统异常”检测到异常IP后可一键加入黑名单
- **智能异常IP检测** - 自动统计异常IP行为，达到阈值后自动加入黑名单，支持异常IP统计分析
- **设置防火墙规则** - 强大的防火墙管理，支持基本和高级规则配置
- **设置WAF规则** - Web应用防火墙规则配置，保护Web应用安全
- **优化系统参数** - 自动优化系统参数，提升服务器性能和安全性
- **一键安全加固** - 一键执行全面的安全加固配置
- **恶意文件清理** - 扫描和清理系统中的恶意文件
- **系统垃圾清理** - 清理临时文件、日志文件、包管理器缓存等系统垃圾
- **深度系统清理** - 深度清理Docker文件、数据库日志、编译缓存、网站缓存等
- **CPU进程清理** - 自动修复高CPU使用率问题
- **内存进程清理** - 自动修复高内存使用率问题
- **一键处理CC攻击** - 快速响应和处理CC攻击事件
- **清理可疑进程** - 自动清理挖矿木马等可疑进程
- **宝塔面板文件白名单** - 智能识别宝塔面板文件，避免误判

## 安装方法

### 方法一：一键安装（推荐）

```bash
# 下载安装脚本
wget https://github.com/pqdm/bt/raw/main/install.sh -O install.sh

# 设置执行权限
chmod +x install.sh

# 运行安装脚本
./install.sh
```

### 方法二：手动安装

```bash
# 创建必要的目录
mkdir -p /root/cc_modules

# 下载主脚本
wget https://github.com/pqdm/bt/raw/main/ding.sh -O /usr/local/bin/ding
chmod +x /usr/local/bin/ding

# 创建软链接
ln -sf /usr/local/bin/ding /root/cc_defense.sh

# 下载配置文件
wget https://github.com/pqdm/bt/raw/main/cc_config.conf -O /root/cc_config.conf

# 下载模块文件
wget https://github.com/pqdm/bt/raw/main/cc_modules/analyzer.sh -O /root/cc_modules/analyzer.sh
wget https://github.com/pqdm/bt/raw/main/cc_modules/blacklist.sh -O /root/cc_modules/blacklist.sh
wget https://github.com/pqdm/bt/raw/main/cc_modules/cleaner.sh -O /root/cc_modules/cleaner.sh
wget https://github.com/pqdm/bt/raw/main/cc_modules/firewall.sh -O /root/cc_modules/firewall.sh
wget https://github.com/pqdm/bt/raw/main/cc_modules/monitor.sh -O /root/cc_modules/monitor.sh
wget https://github.com/pqdm/bt/raw/main/cc_modules/optimizer.sh -O /root/cc_modules/optimizer.sh
wget https://github.com/pqdm/bt/raw/main/cc_modules/waf.sh -O /root/cc_modules/waf.sh

# 设置执行权限
chmod +x /root/cc_modules/*.sh

# 创建黑白名单文件
touch /root/cc_blacklist.txt
touch /root/cc_whitelist.txt
```

## 快速开始

### 1. 安装工具
```bash
# 一键安装
wget https://github.com/pqdm/bt/raw/main/install.sh -O install.sh
chmod +x install.sh
./install.sh
```

### 2. 启动工具
```bash
ding
```

### 3. 基本使用流程
1. **首次使用** - 建议先执行"一键安全加固"进行全面配置
2. **日常监控** - 使用"实时监控系统"查看服务器状态
3. **日志分析** - 定期使用"分析Web访问日志"检查异常流量
4. **攻击处理** - 发现攻击时使用"一键处理CC攻击"快速响应

## 使用方法

安装完成后，您可以通过以下命令启动系统：

```bash
ding
```

在主菜单中，您可以选择不同的功能：

## 功能分类说明

### 📊 **系统监控**
1. **实时监控系统** - 实时监控系统资源使用情况
2. **检测系统异常** - 检测系统运行异常
3. **查看系统信息** - 显示详细的系统信息

### 🔍 **日志分析**
4. **分析Web访问日志** - 分析Web服务器访问日志
5. **监控CC攻击** - 实时监控和检测CC攻击
6. **监控异常进程** - 监控系统中的异常进程
29. **异常IP统计** - 查看异常IP统计信息，管理异常IP记录

### 🛡️ **安全防护**
7. **查看黑名单** - 查看当前黑名单和白名单
8. **管理黑名单** - 管理IP黑名单和白名单
9. **设置防火墙规则** - 配置防火墙规则
10. **设置WAF规则** - 配置Web应用防火墙规则
11. **SSH端口安全变更** - 安全地更改SSH端口
12. **检查SSH连接状态** - 查看SSH连接状态

### 🗑️ **系统清理**
13. **恶意文件清理** - 扫描和清理恶意文件
14. **系统垃圾清理** - 清理系统临时文件和缓存
15. **深度清理系统** - 执行更彻底的系统清理

### ⚡ **性能优化**
16. **优化系统参数** - 优化系统性能参数
17. **CPU进程清理** - 自动修复高CPU使用率
18. **内存进程清理** - 自动修复高内存使用率

### 🚨 **应急处理**
19. **一键处理CC攻击** - 快速处理CC攻击
20. **清理可疑进程** - 清理挖矿木马等可疑进程
21. **一键安全加固** - 执行全面的安全加固

### ⚙️ **系统管理**
22. **配置选项** - 管理工具配置
23. **关于** - 显示工具信息
24. **检查更新** - 检查工具更新
25. **卸载工具** - 卸载维护工具
0. **退出** - 退出程序

或者使用命令行参数：

```bash
# 显示帮助信息
ding --help

# 实时监控系统
ding --monitor

# 分析Web访问日志
ding --analyze

# 查看黑名单
ding --blacklist

# 设置防火墙规则
ding --firewall

# 设置WAF规则
ding --waf

# 优化系统参数
ding --optimize

# 一键安全加固
ding --hardening

# 清理防火墙规则
ding --clean-firewall

# 检查更新
ding --update

# 显示版本信息
ding --version
```

## 卸载方法

如果您需要卸载宝塔面板服务器维护工具，可以使用以下命令：

```bash
# 下载卸载脚本
wget https://github.com/pqdm/bt/raw/main/uninstall.sh -O uninstall.sh

# 设置执行权限
chmod +x uninstall.sh

# 运行卸载脚本
./uninstall.sh
```

卸载脚本会自动清理防火墙规则、删除所有相关文件和配置。

## 技术架构

本工具采用模块化设计，主要包含以下组件：

### 核心模块
- **主控制模块** (`ding.sh`) - 程序入口和菜单控制
- **配置管理** (`cc_config.conf`) - 统一配置管理

### 功能模块
- **analyzer.sh** - 日志分析和流量监控
- **blacklist.sh** - 黑白名单管理
- **cleaner.sh** - 恶意文件清理
- **garbage_cleaner.sh** - 系统垃圾清理
- **cleanup_analyzer.sh** - 清理分析和策略推荐
- **firewall.sh** - 防火墙规则管理
- **monitor.sh** - 系统实时监控
- **optimizer.sh** - 系统优化和性能调优
- **updater.sh** - 自动更新检查
- **waf.sh** - Web应用防火墙管理

### 支持文件
- **install.sh** - 一键安装脚本
- **uninstall.sh** - 一键卸载脚本
- **cc_config_bt_whitelist.conf** - 宝塔面板文件白名单配置

## 配置说明

配置文件位于 `/root/cc_config.conf`，您可以根据需要修改配置参数。

### 主要配置项
- **CC攻击检测阈值** - 设置IP和URL请求频率阈值
- **自动防护配置** - 配置自动黑名单和进程终止
- **监控配置** - 设置监控更新间隔
- **告警配置** - 配置CPU、内存、磁盘使用率告警阈值
- **Web服务器配置** - 支持Nginx和Apache
- **宝塔面板白名单** - 配置宝塔面板文件保护规则

### 宝塔面板白名单配置
宝塔面板文件白名单配置文件位于 `cc_config_bt_whitelist.conf`，包含：
- **核心目录白名单** - 保护宝塔面板相关目录
- **文件名白名单** - 保护宝塔面板特定文件
- **进程白名单** - 保护宝塔面板相关进程
- **文件类型说明** - 提供详细的文件用途说明

## 注意事项

1. 本系统需要root权限运行
2. 建议在使用前备份重要数据
3. 本系统仅供学习和研究使用，请勿用于非法用途

## 更新日志

### v2.1.5 (2025.09.06)
- 自动检测：输入按“小时”计（1=每小时，2=每2小时），定时任务与前台循环统一按小时生效

### v2.1.4 (2025.09.06)
- 新增：主页新增 30. 自动检测，可配置检测间隔与是否自动加入黑名单（永久），自动模式下不再弹出一键拉黑提示
- 统一：所有加入黑名单默认永久封禁

### v2.1.3 (2025.09.06)
- CPU监控增强：新增3秒多次采样、每核展开、输出us/sy/wa/st/id，并含告警阈值（used≥85%、wa≥10%、st≥10%）
- 系统异常一键拉黑：在“检测系统异常”中，可对本次检测出的异常IP一键加入黑名单（默认2小时），自动跳过白名单/已在黑名单IP
- 异常收集优化：连接数异常、失败登录异常统一汇总并展示
- 更新机制完善：更新时同步根目录文件（`VERSION`、`cc_config.conf`、`cc_config_bt_whitelist.conf`）和所有模块，确保版本一致
- 建议：安装`sysstat`以启用更精确的每核统计（`mpstat`）

### v2.1.0 (2025.01.XX)
- **新增功能** - 添加系统垃圾清理功能，支持清理临时文件、日志文件、包管理器缓存等
- **深度清理** - 新增深度清理系统功能，支持清理Docker文件、数据库日志、编译缓存、网站缓存等
- **智能黑名单** - 新增异常IP自动统计功能，IP异常达到5次以上自动加入黑名单
- **异常IP统计** - 新增异常IP统计查看功能，支持查看IP异常次数排行和最近异常记录
- **智能检测** - 系统异常检测中新增失败登录IP和异常连接IP的自动记录
- **自动防护** - 异常IP达到阈值后自动加入黑名单，支持邮件告警通知
- **日志管理** - 支持清理30天前的异常IP记录，保持日志文件合理大小
- **智能分析** - 新增预估清理空间功能，可预先分析可清理的文件大小
- **策略推荐** - 新增清理策略推荐功能，根据磁盘使用情况智能推荐清理方案
- **安全检查** - 新增清理前安全检查功能，检查系统服务状态和负载情况
- **性能统计** - 添加清理性能统计，显示清理速度和文件处理效率
- **清理报告** - 自动生成详细的清理报告，记录清理过程和结果
- **扩展清理** - 支持清理systemd日志、pip缓存、npm缓存、gem缓存等更多类型
- **智能保护** - 清理过程中自动识别并保护重要系统文件和宝塔面板文件
- **空间统计** - 显示清理释放的磁盘空间大小，便于了解清理效果
- **安全保护** - 深度清理前提示用户备份重要数据，确保系统安全
- **菜单优化** - 在主菜单和恶意文件清理菜单中添加新的清理选项，优化菜单图标显示
- **文档更新** - 完善功能说明和使用指南

### v2.0.2 (2025.09.04)
- **重大优化** - 添加宝塔面板文件白名单功能，解决误判问题
- **智能识别** - 自动识别宝塔面板文件，避免误删重要系统文件
- **文件保护** - 保护宝塔面板图标、安全检测、任务管理等文件
- **详细说明** - 为每个文件提供清晰的类型说明和用途
- **提高准确性** - 大幅减少清理功能中的误判情况


### v2.0.1 (2025.09.03)
- 修复了恶意文件清理功能中的用户交互问题
- 添加了文件类型注释，帮助用户识别可疑文件
- 改进了实时监控功能，添加了按'q'键返回主菜单的功能
- 优化了更新检测机制，提高了稳定性
- 新增CPU进程清理功能，自动修复高CPU使用率问题
- 新增内存进程清理功能，自动修复高内存使用率问题
- 新增一键处理CC攻击功能，快速响应攻击事件
- 新增清理可疑进程功能，自动清理挖矿木马等恶意进程
- 优化了主菜单界面，增加了功能描述
- 改进了命令行参数处理，增加了版本信息显示
- 修复了其他已知问题

### v2.0.0
- 全新的界面设计
- 增加了更多的防护功能
- 优化了系统性能
- 增加了恶意文件清理功能
- 模块化架构设计，提高代码可维护性

## 常见问题

### Q: 工具需要什么系统要求？
A: 支持CentOS、Ubuntu、Debian等主流Linux发行版，需要root权限运行。

### Q: 如何配置CC攻击检测阈值？
A: 编辑 `/root/cc_config.conf` 文件，修改 `CC_IP_THRESHOLD` 和 `CC_URL_THRESHOLD` 参数。

### Q: 防火墙规则会影响正常访问吗？
A: 工具会智能识别正常流量，建议先使用白名单功能保护重要IP。

### Q: 如何恢复被误封的IP？
A: 使用"管理黑名单"功能，将IP添加到白名单或从黑名单中移除。

### Q: 工具会自动更新吗？
A: 工具支持检查更新，但需要手动确认是否安装更新。

### Q: 卸载工具会影响服务器安全吗？
A: 卸载时会清理所有相关规则和文件，建议在卸载前备份重要配置。

### Q: 宝塔面板文件会被误判为恶意文件吗？
A: v2.0.2版本已添加宝塔面板文件白名单功能，会自动识别并保护宝塔面板相关文件，避免误判。

### Q: 如何自定义宝塔面板白名单？
A: 编辑 `cc_config_bt_whitelist.conf` 文件，根据需要添加或修改白名单规则。

### Q: 清理功能会删除宝塔面板文件吗？
A: 不会。工具会智能识别宝塔面板文件并自动跳过，确保系统文件安全。

### Q: 系统垃圾清理功能都清理什么？
A: 主要清理临时文件、过期日志、包管理器缓存、回收站、PHP会话文件、核心转储文件等系统垃圾，释放磁盘空间。

### Q: 深度清理系统安全吗？
A: 深度清理会执行更彻底的清理操作，包括Docker文件、数据库日志、网站缓存等。使用前请务必备份重要数据，工具会在执行前提示确认。

### Q: 清理功能能释放多少磁盘空间？
A: 释放的空间取决于系统使用情况和垃圾文件积累程度。工具会显示清理前后的磁盘使用情况和释放的空间大小。

### Q: 清理过程中会影响网站运行吗？
A: 常规的系统垃圾清理不会影响网站运行。深度清理可能会短暂影响某些服务，建议在维护窗口期执行。

### Q: 预估清理空间功能准确吗？
A: 预估功能会分析临时文件、日志文件和缓存文件的大小，给出较为准确的预估。实际清理效果可能因系统状态而略有差异。

### Q: 清理策略推荐是如何工作的？
A: 系统会自动检测磁盘使用率，当使用率超过90%时推荐深度清理，超过80%时推荐标准清理，否则推荐维护性清理。

### Q: 清理安全检查都检查什么？
A: 安全检查会检测重要服务状态、磁盘剩余空间、系统负载等，确保在安全的状态下执行清理操作。

### Q: 清理报告保存在哪里？
A: 清理报告自动保存在 `/tmp/cleanup_report_时间戳.txt`，包含详细的清理信息和系统状态。

### Q: 如何查看清理性能统计？
A: 每次清理完成后会自动显示性能统计，包括执行时间、清理速度、文件处理速度等信息。

## 许可证

本项目采用 Apache-2.0 license 许可证